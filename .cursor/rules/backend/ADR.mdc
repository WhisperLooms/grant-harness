---
description: Backend Infrastructure Architectural Decision Records
globs:
alwaysApply: false
---

# Architecture Decision Log - Backend Infrastructure

<!--
ADR_AGENT_PROTOCOL v1.0

You (the agent) manage this file as the single source of truth for all backend infrastructure ADRs.

NUMBER RANGE CONVENTION
- Platform ADRs: ADR-0001 to ADR-0999 (.cursor/rules/ADR.mdc)
- Frontend ADRs: ADR-1000 to ADR-1999 (.cursor/rules/frontend/ADR.mdc)
- Backend Infrastructure: ADR-2000 to ADR-2049 (.cursor/rules/backend/ADR.mdc)
- Backend Grant Prototype: ADR-2050 to ADR-2099 (.cursor/rules/backend/grant-prototype/ADR.mdc)
- Backend Grant ADK: ADR-2100 to ADR-2499 (.cursor/rules/backend/ADR.mdc - sections after 2100)

INVARIANTS
- Keep this exact file structure and headings.
- All ADR entries use H2 headings: "## ADR-XXXX — <Title>" (4-digit zero-padded ID).
- Backend Infrastructure ADRs MUST use numbers 2000-2049 only.
- Backend Grant ADK ADRs use numbers 2100-2499 (in this file, separate section).
- Allowed Status values: Proposed | Accepted | Superseded
- Date format: YYYY-MM-DD
- New entries must be appended to the END of the file.
- The Index table between the INDEX markers must always reflect the latest state and be sorted by ID desc (newest on top).
- Each ADR MUST contain: Date, Status, Owner, Context, Decision, Consequences.
- Each ADR must include an explicit anchor `<a id="adr-XXXX"></a>` so links remain stable.

HOW TO ADD A NEW ADR
1) Read the whole file.
2) Compute next ID:
   - Scan for headings matching: ^## ADR-(\d{4}) — .+$
   - next_id = (max captured number) + 1, left-pad to 4 digits.
   - Ensure ID is in correct range (2000-2049 for infrastructure, 2100-2499 for Grant ADK).
3) Create a new ADR section using the "New ADR Entry Template" below.
   - Place it AFTER the last ADR section in the appropriate range.
   - Add an `<a id="adr-XXXX"></a>` line immediately below the heading.
4) Update the Index (between the INDEX markers):
   - Insert/replace the row for this ADR keeping the table sorted by ID descending.
   - Title in the Index MUST link to the anchor: [<Title>](#adr-XXXX)
   - If this ADR supersedes another: set "Supersedes" in this row, and update that older ADR:
       a) Change its Status to "Superseded"
       b) Add "Superseded by: ADR-XXXX" in its Consequences block
       c) Update the older ADR's Index row "Superseded by" column to ADR-XXXX
5) Validate before saving:
   - Exactly one heading exists for ADR-XXXX
   - All required fields are present and non-empty
   - Index contains a row for ADR-XXXX and remains properly sorted
6) Concurrency resolution:
   - If a merge conflict or duplicate ID is detected after reading: recompute next_id from the current file state, rename your heading, anchor, and Index row accordingly, and retry once.

COMMIT MESSAGE SUGGESTION
- "ADR-XXXX: <Short Title> — <Status>"

END ADR_AGENT_PROTOCOL
-->

## Index

<!-- BEGIN:ADR_INDEX -->

| ID   | Title                                                      | Date       | Status   | Supersedes | Superseded by |
| ---- | ---------------------------------------------------------- | ---------- | -------- | ---------- | ------------- |
| 2001 | [Gemini 2.5 Flash Required for File Search](#adr-2001)    | 2025-11-12 | Accepted | —          | —             |

<!-- END:ADR_INDEX -->

---

## New ADR Entry Template (copy for each new decision)

> Replace placeholders, keep section headers. Keep prose concise.

```

## ADR-XXXX — <Short, specific title>

<a id="adr-XXXX"></a>
**Date**: YYYY-MM-DD
**Status**: Proposed | Accepted | Superseded
**Owner**: <Name>

### Context

<1–3 sentences: what changed or what forces drive this decision now>

### Alternatives

<Quick bullet list of alternatives considered, and why they were rejected.>

### Decision

<Single clear decision in active voice; make it testable/verifiable>

### Consequences

* **Pros**: <benefit 1>, <benefit 2>
* **Cons / risks**: <cost 1>, <risk 1>
* **Supersedes**: ADR-NNNN (if any)
* **Superseded by**: ADR-MMMM (filled later if replaced)

### (Optional) Compliance / Verification

<How we'll check this is honored: tests, checks, fitness functions, runbooks>

```

---

# Backend Infrastructure ADRs (2000-2049)

## ADR-2001 — Gemini 2.5 Flash Required for File Search

<a id="adr-2001"></a>
**Date**: 2025-11-12
**Status**: Accepted
**Owner**: Gordon

### Context

Gemini File Search (AI-powered vector search for uploaded documents) is **only supported by Gemini 2.5 models**. This constraint affects both Phase 1 (prototype) and Phase 2 (MVP) as File Search is foundational to the RAG architecture.

During testing, `gemini-2.0-flash-exp` queries failed with: `tools[0].tool_type: required one_of 'tool_type' must have one initialized field`

**Model Compatibility**:
- ❌ `gemini-2.0-flash-exp` - No File Search support
- ❌ `gemini-2.0-flash-thinking-exp` - No File Search support
- ✅ `gemini-2.5-flash` - **Supports File Search** (default)
- ✅ `gemini-2.5-pro` - **Supports File Search** (opt-in for complex queries)

**Evidence**: https://ai.google.dev/gemini-api/docs/models#gemini-2.5-flash

### Alternatives

**Option 1**: `gemini-2.5-flash` (SELECTED)
- $0.075/$0.30 per 1M tokens, fast, File Search compatible
- Selected as default for all corpus queries

**Option 2**: `gemini-2.5-pro`
- $1.25/$5.00 per 1M tokens, more capable reasoning
- Available as opt-in for complex matching

**Option 3**: Build custom vector search (Pinecone, Weaviate)
- Rejected: Additional infrastructure, defeats ADR-2051 (Gemini File Search decision)

### Decision

**Enforce `gemini-2.5-flash` as default model for all Gemini File Search queries in prototype AND MVP.**

**Implementation** (applies to both Phase 1 and Phase 2):
```python
# Default parameter in all File Search methods
model: str = "gemini-2.5-flash"

# Model validation
if "2.5" not in model:
    raise ValueError(
        f"Model '{model}' does not support File Search. "
        "Use 'gemini-2.5-flash' or 'gemini-2.5-pro'."
    )
```

**Configuration**:
- `.env`: `GEMINI_FILE_SEARCH_MODEL=gemini-2.5-flash`
- All `CorpusManager`, `GrantCorpus`, `CompanyCorpus`, `QueryEngine` methods use this default

### Consequences

* **Pros**: File Search works, cost-effective ($0.075 input), fast, stable, Pro available as option
* **Cons / risks**: Model lock-in to 2.5 family, breaking change if 2.0 adds File Search later
* **Supersedes**: N/A (first backend infrastructure ADR)
* **Superseded by**: (none)

### Compliance / Verification

**Phase 1 Evidence**:
- `back/grant-prototype/gemini_store/grant_corpus.py:169` - Default model
- `back/grant-prototype/scripts/test_grant_corpus.py` - Test with gemini-2.5-flash
- All 5 test queries successful with grounding sources

**Phase 2 Requirements**:
- ADK agents must use `gemini-2.5-flash` for File Search tools
- Production code must include model validation
- Monitoring should track model usage and costs

**AI Agent Guidance**: When writing ANY code that queries Gemini File Search (Grant Corpus, Company Corpus, cross-corpus matching), ALWAYS use `gemini-2.5-flash` or `gemini-2.5-pro`. Do NOT use 2.0-series models - they will fail. Set default model parameter to `"gemini-2.5-flash"`. This applies to prototype, MVP, and production code.

---

# Backend Grant ADK ADRs (2100-2499)

<!-- Grant ADK ADRs will be added below this line (Phase 2) -->
